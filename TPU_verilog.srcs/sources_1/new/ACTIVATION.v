`timescale 1ns / 1ps
//////////////////////////////////////////////////////////////////////////////////
// Company: 
// Engineer: 
// 
// Create Date: 11/07/2024 05:02:15 PM
// Design Name: 
// Module Name: ACTIVATION
// Project Name: 
// Target Devices: 
// Tool Versions: 
// Description: 
// 
// Dependencies: 
// 
// Revision:
// Revision 0.01 - File Created
// Additional Comments:
// 
//////////////////////////////////////////////////////////////////////////////////
module ACTIVATION #(
    parameter MATRIX_WIDTH = 14,
    parameter BYTE_WIDTH = 8,
    parameter WORD_WIDTH = 32
)(
    input wire CLK,
    input wire RESET,
    input wire ENABLE,
    
    input wire [1:0] ACTIVATION_FUNCTION,  // 2-bit selector for activation type
    input wire SIGNED_NOT_UNSIGNED,        // Select signed or unsigned mode
    
    input wire [(MATRIX_WIDTH*WORD_WIDTH)-1:0] ACTIVATION_INPUT,  // Flattened input
    output reg [(MATRIX_WIDTH*BYTE_WIDTH)-1:0] ACTIVATION_OUTPUT  // Flattened output
);

    // Sigmoid Lookup Tables
    reg [7:0] SIGMOID_UNSIGNED [0:164];
    reg [7:0] SIGMOID_SIGNED [0:158];

    // Registers and signals for activation input and output processing
    reg [WORD_WIDTH-1:0] INPUT_REG [0:MATRIX_WIDTH-1];
    reg [BYTE_WIDTH-1:0] RELU_OUTPUT [0:MATRIX_WIDTH-1];
    reg [BYTE_WIDTH-1:0] SIGMOID_OUTPUT [0:MATRIX_WIDTH-1];
    reg [BYTE_WIDTH-1:0] OUTPUT_REG [0:MATRIX_WIDTH-1];

    integer i;


initial begin
    // ??? SIGMOID_UNSIGNED
    SIGMOID_UNSIGNED[0] = 128;  SIGMOID_UNSIGNED[1] = 130;  SIGMOID_UNSIGNED[2] = 132;
    SIGMOID_UNSIGNED[3] = 134;  SIGMOID_UNSIGNED[4] = 136;  SIGMOID_UNSIGNED[5] = 138;
    SIGMOID_UNSIGNED[6] = 140;  SIGMOID_UNSIGNED[7] = 142;  SIGMOID_UNSIGNED[8] = 144;
    SIGMOID_UNSIGNED[9] = 146;  SIGMOID_UNSIGNED[10] = 148; SIGMOID_UNSIGNED[11] = 150;
    SIGMOID_UNSIGNED[12] = 152; SIGMOID_UNSIGNED[13] = 154; SIGMOID_UNSIGNED[14] = 156;
    SIGMOID_UNSIGNED[15] = 157; SIGMOID_UNSIGNED[16] = 159; SIGMOID_UNSIGNED[17] = 161;
    SIGMOID_UNSIGNED[18] = 163; SIGMOID_UNSIGNED[19] = 165; SIGMOID_UNSIGNED[20] = 167;
    SIGMOID_UNSIGNED[21] = 169; SIGMOID_UNSIGNED[22] = 170; SIGMOID_UNSIGNED[23] = 172;
    SIGMOID_UNSIGNED[24] = 174; SIGMOID_UNSIGNED[25] = 176; SIGMOID_UNSIGNED[26] = 177;
    SIGMOID_UNSIGNED[27] = 179; SIGMOID_UNSIGNED[28] = 181; SIGMOID_UNSIGNED[29] = 182;
    SIGMOID_UNSIGNED[30] = 184; SIGMOID_UNSIGNED[31] = 186; SIGMOID_UNSIGNED[32] = 187;
    SIGMOID_UNSIGNED[33] = 189; SIGMOID_UNSIGNED[34] = 190; SIGMOID_UNSIGNED[35] = 192;
    SIGMOID_UNSIGNED[36] = 193; SIGMOID_UNSIGNED[37] = 195; SIGMOID_UNSIGNED[38] = 196;
    SIGMOID_UNSIGNED[39] = 198; SIGMOID_UNSIGNED[40] = 199; SIGMOID_UNSIGNED[41] = 200;
    SIGMOID_UNSIGNED[42] = 202; SIGMOID_UNSIGNED[43] = 203; SIGMOID_UNSIGNED[44] = 204;
    SIGMOID_UNSIGNED[45] = 206; SIGMOID_UNSIGNED[46] = 207; SIGMOID_UNSIGNED[47] = 208;
    SIGMOID_UNSIGNED[48] = 209; SIGMOID_UNSIGNED[49] = 210; SIGMOID_UNSIGNED[50] = 212;
    SIGMOID_UNSIGNED[51] = 213; SIGMOID_UNSIGNED[52] = 214; SIGMOID_UNSIGNED[53] = 215;
    SIGMOID_UNSIGNED[54] = 216; SIGMOID_UNSIGNED[55] = 217; SIGMOID_UNSIGNED[56] = 218;
    SIGMOID_UNSIGNED[57] = 219; SIGMOID_UNSIGNED[58] = 220; SIGMOID_UNSIGNED[59] = 221;
    SIGMOID_UNSIGNED[60] = 222; SIGMOID_UNSIGNED[61] = 223; SIGMOID_UNSIGNED[62] = 224;
    SIGMOID_UNSIGNED[63] = 225; SIGMOID_UNSIGNED[64] = 225; SIGMOID_UNSIGNED[65] = 226;
    SIGMOID_UNSIGNED[66] = 227; SIGMOID_UNSIGNED[67] = 228; SIGMOID_UNSIGNED[68] = 229;
    SIGMOID_UNSIGNED[69] = 229; SIGMOID_UNSIGNED[70] = 230; SIGMOID_UNSIGNED[71] = 231;
    SIGMOID_UNSIGNED[72] = 232; SIGMOID_UNSIGNED[73] = 232; SIGMOID_UNSIGNED[74] = 233;
    SIGMOID_UNSIGNED[75] = 234; SIGMOID_UNSIGNED[76] = 234; SIGMOID_UNSIGNED[77] = 235;
    SIGMOID_UNSIGNED[78] = 235; SIGMOID_UNSIGNED[79] = 236; SIGMOID_UNSIGNED[80] = 237;
    SIGMOID_UNSIGNED[81] = 237; SIGMOID_UNSIGNED[82] = 238; SIGMOID_UNSIGNED[83] = 238;
    SIGMOID_UNSIGNED[84] = 239; SIGMOID_UNSIGNED[85] = 239; SIGMOID_UNSIGNED[86] = 240;
    SIGMOID_UNSIGNED[87] = 240; SIGMOID_UNSIGNED[88] = 241; SIGMOID_UNSIGNED[89] = 241;
    SIGMOID_UNSIGNED[90] = 241; SIGMOID_UNSIGNED[91] = 242; SIGMOID_UNSIGNED[92] = 242;
    SIGMOID_UNSIGNED[93] = 243; SIGMOID_UNSIGNED[94] = 243; SIGMOID_UNSIGNED[95] = 243;
    SIGMOID_UNSIGNED[96] = 244; SIGMOID_UNSIGNED[97] = 244; SIGMOID_UNSIGNED[98] = 245;
    SIGMOID_UNSIGNED[99] = 245; SIGMOID_UNSIGNED[100] = 245; SIGMOID_UNSIGNED[101] = 246;
    SIGMOID_UNSIGNED[102] = 246; SIGMOID_UNSIGNED[103] = 246; SIGMOID_UNSIGNED[104] = 246;
    SIGMOID_UNSIGNED[105] = 247; SIGMOID_UNSIGNED[106] = 247; SIGMOID_UNSIGNED[107] = 247;
    SIGMOID_UNSIGNED[108] = 248; SIGMOID_UNSIGNED[109] = 248; SIGMOID_UNSIGNED[110] = 248;
    SIGMOID_UNSIGNED[111] = 248; SIGMOID_UNSIGNED[112] = 248; SIGMOID_UNSIGNED[113] = 249;
    SIGMOID_UNSIGNED[114] = 249; SIGMOID_UNSIGNED[115] = 249; SIGMOID_UNSIGNED[116] = 249;
    SIGMOID_UNSIGNED[117] = 250; SIGMOID_UNSIGNED[118] = 250; SIGMOID_UNSIGNED[119] = 250;
    SIGMOID_UNSIGNED[120] = 250; SIGMOID_UNSIGNED[121] = 250; SIGMOID_UNSIGNED[122] = 250;
    SIGMOID_UNSIGNED[123] = 251; SIGMOID_UNSIGNED[124] = 251; SIGMOID_UNSIGNED[125] = 251;
    SIGMOID_UNSIGNED[126] = 251; SIGMOID_UNSIGNED[127] = 251; SIGMOID_UNSIGNED[128] = 251;
    SIGMOID_UNSIGNED[129] = 252; SIGMOID_UNSIGNED[130] = 252; SIGMOID_UNSIGNED[131] = 252;
    SIGMOID_UNSIGNED[132] = 252; SIGMOID_UNSIGNED[133] = 252; SIGMOID_UNSIGNED[134] = 252;
    SIGMOID_UNSIGNED[135] = 252; SIGMOID_UNSIGNED[136] = 252; SIGMOID_UNSIGNED[137] = 253;
    SIGMOID_UNSIGNED[138] = 253; SIGMOID_UNSIGNED[139] = 253; SIGMOID_UNSIGNED[140] = 253;
    SIGMOID_UNSIGNED[141] = 253; SIGMOID_UNSIGNED[142] = 253; SIGMOID_UNSIGNED[143] = 253;
    SIGMOID_UNSIGNED[144] = 253; SIGMOID_UNSIGNED[145] = 253; SIGMOID_UNSIGNED[146] = 253;
    SIGMOID_UNSIGNED[147] = 253; SIGMOID_UNSIGNED[148] = 254; SIGMOID_UNSIGNED[149] = 254;
    SIGMOID_UNSIGNED[150] = 254; SIGMOID_UNSIGNED[151] = 254; SIGMOID_UNSIGNED[152] = 254;
    SIGMOID_UNSIGNED[153] = 254; SIGMOID_UNSIGNED[154] = 254; SIGMOID_UNSIGNED[155] = 254;
    SIGMOID_UNSIGNED[156] = 254; SIGMOID_UNSIGNED[157] = 254; SIGMOID_UNSIGNED[158] = 254;
    SIGMOID_UNSIGNED[159] = 254; SIGMOID_UNSIGNED[160] = 254; SIGMOID_UNSIGNED[161] = 254;
    SIGMOID_UNSIGNED[162] = 254; SIGMOID_UNSIGNED[163] = 254; SIGMOID_UNSIGNED[164] = 254;


    // Initialize SIGMOID_SIGNED
    SIGMOID_SIGNED[0] = 1;   SIGMOID_SIGNED[1] = 1;   SIGMOID_SIGNED[2] = 1;
    SIGMOID_SIGNED[3] = 1;   SIGMOID_SIGNED[4] = 1;   SIGMOID_SIGNED[5] = 1;
    SIGMOID_SIGNED[6] = 1;   SIGMOID_SIGNED[7] = 1;   SIGMOID_SIGNED[8] = 1;
    SIGMOID_SIGNED[9] = 1;   SIGMOID_SIGNED[10] = 1;  SIGMOID_SIGNED[11] = 1;
    SIGMOID_SIGNED[12] = 1;  SIGMOID_SIGNED[13] = 1;  SIGMOID_SIGNED[14] = 1;
    SIGMOID_SIGNED[15] = 1;  SIGMOID_SIGNED[16] = 1;  SIGMOID_SIGNED[17] = 2;
    SIGMOID_SIGNED[18] = 2;  SIGMOID_SIGNED[19] = 2;  SIGMOID_SIGNED[20] = 2;
    SIGMOID_SIGNED[21] = 2;  SIGMOID_SIGNED[22] = 2;  SIGMOID_SIGNED[23] = 2;
    SIGMOID_SIGNED[24] = 2;  SIGMOID_SIGNED[25] = 3;  SIGMOID_SIGNED[26] = 3;
    SIGMOID_SIGNED[27] = 3;  SIGMOID_SIGNED[28] = 3;  SIGMOID_SIGNED[29] = 3;
    SIGMOID_SIGNED[30] = 4;  SIGMOID_SIGNED[31] = 4;  SIGMOID_SIGNED[32] = 4;
    SIGMOID_SIGNED[33] = 4;  SIGMOID_SIGNED[34] = 4;  SIGMOID_SIGNED[35] = 5;
    SIGMOID_SIGNED[36] = 5;  SIGMOID_SIGNED[37] = 5;  SIGMOID_SIGNED[38] = 6;
    SIGMOID_SIGNED[39] = 6;  SIGMOID_SIGNED[40] = 6;  SIGMOID_SIGNED[41] = 7;
    SIGMOID_SIGNED[42] = 7;  SIGMOID_SIGNED[43] = 8;  SIGMOID_SIGNED[44] = 8;
    SIGMOID_SIGNED[45] = 9;  SIGMOID_SIGNED[46] = 9;  SIGMOID_SIGNED[47] = 10;
    SIGMOID_SIGNED[48] = 10; SIGMOID_SIGNED[49] = 11; SIGMOID_SIGNED[50] = 12;
    SIGMOID_SIGNED[51] = 12; SIGMOID_SIGNED[52] = 13; SIGMOID_SIGNED[53] = 14;
    SIGMOID_SIGNED[54] = 14; SIGMOID_SIGNED[55] = 15; SIGMOID_SIGNED[56] = 16;
    SIGMOID_SIGNED[57] = 17; SIGMOID_SIGNED[58] = 18; SIGMOID_SIGNED[59] = 19;
    SIGMOID_SIGNED[60] = 20; SIGMOID_SIGNED[61] = 21; SIGMOID_SIGNED[62] = 22;
    SIGMOID_SIGNED[63] = 23; SIGMOID_SIGNED[64] = 25; SIGMOID_SIGNED[65] = 26;
    SIGMOID_SIGNED[66] = 27; SIGMOID_SIGNED[67] = 29; SIGMOID_SIGNED[68] = 30;
    SIGMOID_SIGNED[69] = 31; SIGMOID_SIGNED[70] = 33; SIGMOID_SIGNED[71] = 34;
    SIGMOID_SIGNED[72] = 36; SIGMOID_SIGNED[73] = 38; SIGMOID_SIGNED[74] = 39;
    SIGMOID_SIGNED[75] = 41; SIGMOID_SIGNED[76] = 43; SIGMOID_SIGNED[77] = 45;
    SIGMOID_SIGNED[78] = 46; SIGMOID_SIGNED[79] = 48; SIGMOID_SIGNED[80] = 50;
    SIGMOID_SIGNED[81] = 52; SIGMOID_SIGNED[82] = 54; SIGMOID_SIGNED[83] = 56;
    SIGMOID_SIGNED[84] = 58; SIGMOID_SIGNED[85] = 60; SIGMOID_SIGNED[86] = 62;
    SIGMOID_SIGNED[87] = 64; SIGMOID_SIGNED[88] = 66; SIGMOID_SIGNED[89] = 68;
    SIGMOID_SIGNED[90] = 70; SIGMOID_SIGNED[91] = 72; SIGMOID_SIGNED[92] = 74;
    SIGMOID_SIGNED[93] = 76; SIGMOID_SIGNED[94] = 78; SIGMOID_SIGNED[95] = 80;
    SIGMOID_SIGNED[96] = 82; SIGMOID_SIGNED[97] = 83; SIGMOID_SIGNED[98] = 85;
    SIGMOID_SIGNED[99] = 87; SIGMOID_SIGNED[100] = 89; SIGMOID_SIGNED[101] = 90;
    SIGMOID_SIGNED[102] = 92; SIGMOID_SIGNED[103] = 94; SIGMOID_SIGNED[104] = 95;
    SIGMOID_SIGNED[105] = 97; SIGMOID_SIGNED[106] = 98; SIGMOID_SIGNED[107] = 99;
    SIGMOID_SIGNED[108] = 101; SIGMOID_SIGNED[109] = 102; SIGMOID_SIGNED[110] = 103;
    SIGMOID_SIGNED[111] = 105; SIGMOID_SIGNED[112] = 106; SIGMOID_SIGNED[113] = 107;
    SIGMOID_SIGNED[114] = 108; SIGMOID_SIGNED[115] = 109; SIGMOID_SIGNED[116] = 110;
    SIGMOID_SIGNED[117] = 111; SIGMOID_SIGNED[118] = 112; SIGMOID_SIGNED[119] = 113;
    SIGMOID_SIGNED[120] = 114; SIGMOID_SIGNED[121] = 114; SIGMOID_SIGNED[122] = 115;
    SIGMOID_SIGNED[123] = 116; SIGMOID_SIGNED[124] = 116; SIGMOID_SIGNED[125] = 117;
    SIGMOID_SIGNED[126] = 118; SIGMOID_SIGNED[127] = 118; SIGMOID_SIGNED[128] = 119;
    SIGMOID_SIGNED[129] = 119; SIGMOID_SIGNED[130] = 120; SIGMOID_SIGNED[131] = 120;
    SIGMOID_SIGNED[132] = 121; SIGMOID_SIGNED[133] = 121; SIGMOID_SIGNED[134] = 122;
    SIGMOID_SIGNED[135] = 122; SIGMOID_SIGNED[136] = 122; SIGMOID_SIGNED[137] = 123;
    SIGMOID_SIGNED[138] = 123; SIGMOID_SIGNED[139] = 123; SIGMOID_SIGNED[140] = 124;
    SIGMOID_SIGNED[141] = 124; SIGMOID_SIGNED[142] = 124; SIGMOID_SIGNED[143] = 124;
    SIGMOID_SIGNED[144] = 124; SIGMOID_SIGNED[145] = 125; SIGMOID_SIGNED[146] = 125;
    SIGMOID_SIGNED[147] = 125; SIGMOID_SIGNED[148] = 125; SIGMOID_SIGNED[149] = 125;
    SIGMOID_SIGNED[150] = 126; SIGMOID_SIGNED[151] = 126; SIGMOID_SIGNED[152] = 126;
    SIGMOID_SIGNED[153] = 126; SIGMOID_SIGNED[154] = 126; SIGMOID_SIGNED[155] = 126;
    SIGMOID_SIGNED[156] = 126; SIGMOID_SIGNED[157] = 126; SIGMOID_SIGNED[158] = 127;
end

   always @* begin
        for (i = 0; i < MATRIX_WIDTH; i = i + 1) begin
            INPUT_REG[i] = ACTIVATION_INPUT[(i+1)*WORD_WIDTH-1 -: WORD_WIDTH];
        end
    end

    // ReLU ????
    always @* begin
        for (i = 0; i < MATRIX_WIDTH; i = i + 1) begin
            if (SIGNED_NOT_UNSIGNED) begin
                // ??? ReLU
                if ($signed(INPUT_REG[i][WORD_WIDTH-1:BYTE_WIDTH*3]) < 0)
                    RELU_OUTPUT[i] = 0;
                else if ($signed(INPUT_REG[i][WORD_WIDTH-1:BYTE_WIDTH*3]) > 127)
                    RELU_OUTPUT[i] = 127;
                else
                    RELU_OUTPUT[i] = INPUT_REG[i][WORD_WIDTH-1:BYTE_WIDTH*3];
            end else begin
                // ??? ReLU
                if ($unsigned(INPUT_REG[i][WORD_WIDTH-1:BYTE_WIDTH*3]) > 255)
                    RELU_OUTPUT[i] = 255;
                else
                    RELU_OUTPUT[i] = INPUT_REG[i][WORD_WIDTH-1:BYTE_WIDTH*3];
            end
        end
    end

    // Sigmoid ????
    always @* begin
        for (i = 0; i < MATRIX_WIDTH; i = i + 1) begin
            if (SIGNED_NOT_UNSIGNED) begin
                if ($signed(INPUT_REG[i][WORD_WIDTH-1:BYTE_WIDTH*2-4]) < -88)
                    SIGMOID_OUTPUT[i] = 0;
                else if ($signed(INPUT_REG[i][WORD_WIDTH-1:BYTE_WIDTH*2-4]) > 70)
                    SIGMOID_OUTPUT[i] = 127;
                else
                    SIGMOID_OUTPUT[i] = SIGMOID_SIGNED[$signed(INPUT_REG[i][WORD_WIDTH-1:BYTE_WIDTH*2-4])];
            end else begin
                if ($unsigned(INPUT_REG[i][WORD_WIDTH-1:BYTE_WIDTH*2-4]) > 164)
                    SIGMOID_OUTPUT[i] = 255;
                else
                    SIGMOID_OUTPUT[i] = SIGMOID_UNSIGNED[$unsigned(INPUT_REG[i][WORD_WIDTH-1:BYTE_WIDTH*2-4])];
            end
        end
    end

    // ??????????
    always @* begin
        case (ACTIVATION_FUNCTION)
            2'b00: begin // ReLU
                for (i = 0; i < MATRIX_WIDTH; i = i + 1) begin
                    OUTPUT_REG[i] = RELU_OUTPUT[i];
                end
            end
            2'b01: begin // Sigmoid
                for (i = 0; i < MATRIX_WIDTH; i = i + 1) begin
                    OUTPUT_REG[i] = SIGMOID_OUTPUT[i];
                end
            end
            2'b10: begin // No Activation
                for (i = 0; i < MATRIX_WIDTH; i = i + 1) begin
                    OUTPUT_REG[i] = INPUT_REG[i][BYTE_WIDTH*4-1:BYTE_WIDTH*3];
                end
            end
            default: begin
                for (i = 0; i < MATRIX_WIDTH; i = i + 1) begin
                    OUTPUT_REG[i] = 8'd0;
                end
            end
        endcase
    end

    // ?????????????
    always @* begin
        for (i = 0; i < MATRIX_WIDTH; i = i + 1) begin
            ACTIVATION_OUTPUT[(i+1)*BYTE_WIDTH-1 -: BYTE_WIDTH] = OUTPUT_REG[i];
        end
    end

endmodule